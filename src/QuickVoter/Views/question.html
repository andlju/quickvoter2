@Master['Layout.html']

@Section['Content']

<!-- ko with: question -->

<header class="container">
    <h2 data-bind="text: text"></h2>
</header>
<h3 data-bind="text:currentLeader().text"></h3>
<section id="currentQuestions" class="container">
    <div class="row">
        <div class="col-lg-10">
            <table class="table table-striped question-list">
                <thead>
                    <tr>
                        <th class="text-center"></th>
                        <th class="text-center">Votes</th>
                        <th>Answer</th>
                    </tr>
                </thead>
                <tbody data-bind="foreach: answers">
                    <tr>
                        <td class="text-center"><button class="btn btn-sm btn-primary" data-bind="click: addVote">Vote</button></td>
                        <td class="number-of-votes" data-bind="text: votes"></td>
                        <td>
                            <div class="answer" data-bind="text: text, css: { leading : $parent.currentLeader() == $data }"></div>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2"></td>
                        <td>
                            <form class="form-inline" action="" data-bind="submit: addAnswer">
                                <div class="input-group">
                                    <input type="text" placeholder="New answer" data-bind="value: newAnswer" class="form-control">
                                    <span class="input-group-btn">
                                        <button type="submit" class="btn btn-primary">Add</button>
                                    </span>
                                </div><!-- /input-group -->
                            </form>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</section>

<!-- /ko -->

@EndSection

@Section['Scripts']

<script type="text/javascript">

    function AnswerViewModel(model) {
        var self = this;

        self.answerId = model.AnswerId;

        self.questionId = model.QuestionId;
        
        self.text = model.Text;
        
        self.votes = ko.observable(model.Votes);

        self.addVote = function () {
            
            QuestionService.addVote(self.questionId, self.answerId).done(function(data) {
                // self.votes(data.Votes);
            });
        };
    }
    
    function QuestionViewModel(model) {
        var self = this;

        self.questionId = model.QuestionId;
        
        self.text = model.Text;
        
        self.answers =
            ko.observableArray(
                $.map(model.Answers, function (a) { return new AnswerViewModel(a); }));

        self.currentLeader = function() {
            var currentLeader = null;
            for (var idx in self.answers()) {
                var a = self.answers()[idx];
                if (!currentLeader || a.votes() > currentLeader.votes())
                    currentLeader = a;
            }
            return currentLeader;
        };

        self.answerUpdated = function (data) {
            
            var answerId = data.AnswerId;
            
            for (var idx in self.answers()) {
                var a = self.answers()[idx];
                if (a.answerId == answerId) {
                    a.votes(data.Votes);
                    break;
                }
            }
        };
        
        self.answerAdded = function(data) {
            var a = new AnswerViewModel(data);
            self.answers.push(a);
        };
        
        self.newAnswer = ko.observable();

        self.addAnswer = function () {
            
            QuestionService.addAnswer(self.questionId, self.newAnswer()).done(function(data) {
            });

            self.newAnswer('');
        };

    }
    
    function PageViewModel() {
        var self = this;

        self.hub = $.connection.questionsHub;

        self.hub.client.answerUpdated = function(data) {
            self.question().answerUpdated(data);
        };

        self.hub.client.answerAdded = function(data) {
            self.question().answerAdded(data);
        };
        
        self.question = ko.observable();

        self.reloadQuestion = function() {
            QuestionService.getQuestion('@Model.questionId').done(function(data) {
                var q = new QuestionViewModel(data);
                self.question(q);
                self.hub.server.registerClient(data.QuestionId);

            });
        };

        $.connection.hub.start().done(function() {
        });
        
        self.reloadQuestion();

    }

    $(function () {

        var pageViewModel = new PageViewModel();

        ko.applyBindings(pageViewModel);

    });
</script>

@EndSection

